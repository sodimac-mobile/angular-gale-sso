/*------------------------------------------------------
 Company:           Gale Framework Ltda.
 Author:            David Gaete <dmunozgaete@gmail.com> (https://github.com/dmunozgaete)
 
 Description:       Angular Gale Single Sign On
 Github:            https://github.com/dmunozgaete/angular-gale-sso

 Versi√≥n:           1.0.0-rc.1
 Build Date:        2018-04-05 10:23:33
------------------------------------------------------*/


angular.module("gale-sso.templates",[]).run(["$templateCache",function($templateCache){"use strict";$templateCache.put("gale-sso/gale-sso.tpl.html",'<sso-loading ng-if=model.isLoading><sso-image><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48c3ZnIHdpZHRoPSc3MnB4JyBoZWlnaHQ9JzcycHgnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHByZXNlcnZlQXNwZWN0UmF0aW89InhNaWRZTWlkIiBjbGFzcz0idWlsLXJpbmctYWx0Ij48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0ibm9uZSIgY2xhc3M9ImJrIj48L3JlY3Q+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDAiIHN0cm9rZT0ibm9uZSIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48L2NpcmNsZT48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgc3Ryb2tlPSIjMDA3MGQxIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hvZmZzZXQiIGR1cj0iM3MiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBmcm9tPSIwIiB0bz0iNTAyIj48L2FuaW1hdGU+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hhcnJheSIgZHVyPSIzcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIHZhbHVlcz0iMTUwLjYgMTAwLjQ7MSAyNTA7MTUwLjYgMTAwLjQiPjwvYW5pbWF0ZT48L2NpcmNsZT48L3N2Zz4="></sso-image><sso-title>Iniciando Plataforma</sso-title><sso-legend>Espere por favor...</sso-legend></sso-loading><iframe frameborder=0 border=0 cellspacing=0 ng-show=!model.isLoading></iframe>')}]),angular.manifiest("gale-sso",["gale-sso.templates","gale-sso.components","gale-sso.services"],["gale"]),angular.module("gale-sso.components").directive("galeSso",["$log","$q","$cordovaSingleSignOn",function($log,$q,$cordovaSingleSignOn){return{restrict:"E",scope:{onLoginSuccess:"&",onLoginError:"&",scopes:"="},templateUrl:"gale-sso/gale-sso.tpl.html",controller:["$scope","$element","$q","$timeout",function($scope,$element,$q,$timeout){var vm=$scope.model={isLoading:!0},_scopes=$scope.scopes||["profile"],oauth2=$cordovaSingleSignOn.$$buildAuthorization(_scopes),iframe=$element.find("iframe");iframe.attr("src",oauth2.oauth2Url);var isLoaded=!1;iframe.bind("load",function(){if(isLoaded)return!1;var delay=$timeout(function(){$timeout.cancel(delay),isLoaded=!0,vm.isLoading=!1;var finaly=!1,windowElm=angular.element(window),fn=function(e){finaly||e.origin!==oauth2.hostToMatch||0!==e.data.indexOf(oauth2.callbackUrl)||(windowElm.unbind("message",fn),oauth2.parser(e.data).then(function(data){var handler=$scope.onLoginSuccess();handler&&handler(data)},function(e){var handler=$scope.onLoginError();handler&&handler(e)}),finaly=!0)};windowElm.bind("message",fn)},10)}),$scope.$on("$destroy",function(){})}]}}]),angular.module("gale-sso.services").provider("$cordovaSingleSignOn",function(){var $this=this,_appId=null,_ssoBaseURL=null,_ssoBaseAuthURL=null,_ssoLabel="$sso:perApp:state";this.setAppId=function(value){return _appId=value,$this},this.setApiUrl=function(value){return value&&!value.endsWith("/")&&(value+="/"),_ssoBaseURL=value,$this},this.setApiAuthUrl=function(value){return _ssoBaseAuthURL=value,$this},this.$get=["$q","$Api","$Identity","$LocalStorage",function($q,$Api,$Identity,$LocalStorage){var self=this,_authResponse=null;$Identity.isAuthenticated()&&(_authResponse={connected:"connected",access_token:$Identity.getAccessToken()}),self.getAppId=function(){if(!_appId)throw Error("APP_ID_NOT_SET");return _appId},self.getApiUrl=function(){if(!_ssoBaseURL)throw Error("SSO_BASEURL_NOT_SET");return _ssoBaseURL},self.getApiAuthUrl=function(){if(!_ssoBaseURL)throw Error("SSO_BASEURL_NOT_SET");return _ssoBaseAuthURL},self.getAccessToken=function(){if(!_authResponse)throw Error("MUST_CALL_LOGIN_BEFORE_GET_ACCESSTOKEN");return _authResponse.access_token};var parseFragment=function(uri){var parsed=$q.defer(),qs=uri.substring(uri.indexOf("#")+1).split("&"),build=function(tokens){var j={};for(var q in qs){var text=qs[q];for(var prop in tokens){var name=tokens[prop];if(0!==text.indexOf(name));else{var value=text.replace(name+"=","");j[tokens[prop]]="expires_in"===name?parseInt(value):value}}}return j};return setTimeout(function(){var isSuccess=function(){var ok=!1;return angular.forEach(qs,function(q){return 0===q.indexOf("access_token")?(ok=!0,!1):void 0}),ok}();if(isSuccess){var j1=build(["access_token","expires_in","token_type"]);_authResponse=j1;var result={authResponse:j1,status:"connected"};$LocalStorage.setObject(_ssoLabel,result),parsed.resolve(result)}else{var j2=build(["error"]);parsed.reject({status:"not_connected",error:j2})}},10),parsed.promise};return self.$$buildAuthorization=function(permissions,settings){var _settings=settings||{},scopes=permissions.join(","),response_type="token",redirect_uri="oauth2/v2/connect/oauth2_callback.html?origin=",state=_settings.state||null,prompt=_settings.prompt||"consent",curr_bearerToken=$LocalStorage.getObject(_ssoLabel)||null;curr_bearerToken&&(curr_bearerToken=curr_bearerToken.authResponse.access_token);var api_url=self.getApiUrl(),host_url=function(){var pathArray=api_url.split("/"),protocol=pathArray[0],host=pathArray[2],url=protocol+"//"+host;return url}(),callback_url=api_url+redirect_uri+location.origin;settings&&settings.redirect_uri&&(callback_url=settings.redirect_uri);var oauth2_url=[self.getApiAuthUrl(),"?response_type=",response_type,"&client_id=",self.getAppId(),"&redirect_uri=",callback_url,"&scope=",scopes,"&prompt=",prompt,"&state=",state,"&_wbvf=",curr_bearerToken].join("");return{oauth2Url:oauth2_url,hostToMatch:host_url,callbackUrl:callback_url,parser:parseFragment}},self.login=function(permissions,settings){var defer=$q.defer(),mode="object"==typeof ionic?"ionic":"browser";"ionic"===mode&&(ionic.Platform.isWebView()||(mode="browser"));var oauth2=self.$$buildAuthorization(permissions,settings);switch(mode){case"ionic":var inApp_features=["toolbar=no","location=no","clearsessioncache=no","clearcache=no"].join(","),browser=cordova.InAppBrowser.open(oauth2.oauth2Url,"_blank",inApp_features);browser.addEventListener("loadstop",function(e){0===e.url.indexOf(oauth2.callbackUrl)&&parseFragment(e.url).then(function(data){browser.close(),defer.resolve(data)},function(e){browser.close(),defer.reject(e)})});break;case"browser":var height=600,width=650,left=screen.width/2-width/2,top=screen.height/2-height/2,browser_features=["toolbar=0","location=0","directories=0","status=0","menubar=0","scrollbars=0","resizable=0","copyhistory=0","width="+width,"height="+height,"top="+top,"left="+left].join(","),finaly=!1,windowElm=angular.element(window),fn=(window.open(oauth2.oauth2Url,"oauth2_sso",browser_features),function(e){finaly||e.origin!==oauth2.hostToMatch||0!==e.data.indexOf(oauth2.callbackUrl)||(windowElm.unbind("message",fn),parseFragment(e.data).then(function(data){defer.resolve(data)},function(e){defer.reject(e)}),finaly=!0)});windowElm.bind("message",fn)}return defer.promise},self.api=function(query){var defer=$q.defer(),accessToken=self.getAccessToken();switch(query){case"addresses":query="me/addresses"}return $Api.read("{sso_url}Accounts/{query}",{sso_url:self.getApiUrl(),query:query},{Authorization:"Bearer "+accessToken}).success(function(data){defer.resolve(data)}).error(function(err){defer.reject(err)}),defer.promise},self}]});
//# sourceMappingURL=angular-gale-sso.min.js.map